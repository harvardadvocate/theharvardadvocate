# The Harvard Advocate - Web Application

The frontend website for The Harvard Advocate, built with Next.js 14 using the Pages Router architecture with Static Site Generation (SSG) and Incremental Static Regeneration (ISR).

## Architecture Overview

This is a statically-generated website that pulls content from Sanity CMS. All pages are pre-rendered at build time for optimal performance and SEO, then automatically revalidated every hour to keep content fresh.

### Key Technologies

- **Next.js 14** - React framework with Pages Router
- **React 18** - UI library
- **Sanity CMS** - Headless content management
- **Theme UI** - Design system and theming
- **Emotion** - CSS-in-JS
- **next-seo** - SEO optimization

### Rendering Strategy

**Static Site Generation (SSG):**
- All pages pre-rendered to HTML at build time
- No client-side data fetching on page load
- Instant page loads with full SEO support

**Incremental Static Regeneration (ISR):**
- Pages automatically revalidate every 3600 seconds (1 hour)
- Webhook-triggered on-demand revalidation when content changes
- New pages generated on-demand with `fallback: 'blocking'`

## Project Structure

```
web/
├── pages/                    # Next.js pages (file-based routing)
│   ├── _app.js               # App wrapper with Theme UI provider
│   ├── _document.js          # HTML document structure
│   ├── index.js              # Homepage (/)
│   ├── about.js              # About page (/about)
│   ├── content/
│   │   └── [slug].js         # Article pages (/content/:slug)
│   ├── issues/
│   │   ├── index.js          # Issues list (/issues)
│   │   └── [issueSlug].js    # Issue detail (/issues/:issueSlug)
│   ├── sections/
│   │   ├── index.js          # Sections overview (/sections)
│   │   └── [sectionSlug].js  # Section pages (/sections/:sectionSlug)
│   ├── authors/
│   │   └── [authorSlug].js   # Author pages (/authors/:authorSlug)
│   └── api/
│       └── revalidate.js     # Webhook for on-demand revalidation
├── lib/                      # Utilities and configuration
│   ├── sanity.js             # Sanity client configuration
│   ├── queries/              # GROQ queries for Sanity
│   ├── seo/                  # SEO schemas and utilities
│   ├── theme/                # Theme UI configuration
│   └── utils/                # Helper functions
├── src/                      # Components and legacy code
│   ├── components/           # Reusable React components
│   │   ├── Sidebar.js        # Navigation sidebar
│   │   ├── ContentCard.js    # Article preview cards
│   │   ├── IssueCard.js      # Issue cards
│   │   └── ...
│   ├── pages/                # LEGACY: Old CRA page components (not used)
│   └── assets/               # Fonts and static assets
├── public/                   # Static files served at /
│   ├── robots.txt            # Generated by next-sitemap
│   └── sitemap.xml           # Generated by next-sitemap
├── next.config.js            # Next.js configuration
├── next-sitemap.config.js    # Sitemap generation config
└── package.json              # Dependencies and scripts
```

### Important Note on `src/` Directory

The `src/` directory contains components from the original Create React App architecture. While the routing has been completely migrated to Next.js Pages Router, many components in `src/components/` are still actively used. The old page components in `src/pages/` are NOT used anymore.

## Data Fetching Pattern

All dynamic pages follow the same SSG + ISR pattern:

```javascript
// 1. Generate all possible paths at build time
export async function getStaticPaths() {
  const slugs = await sanityClient.fetch(
    `*[_type == "contentItem"].slug.current`
  );

  return {
    paths: slugs.map(slug => ({ params: { slug } })),
    fallback: 'blocking', // Generate new pages on-demand
  };
}

// 2. Fetch data for each path at build time
export async function getStaticProps({ params }) {
  const data = await sanityClient.fetch(query, { slug: params.slug });

  return {
    props: { data },
    revalidate: 3600, // Revalidate every hour
  };
}

// 3. Render the page component
export default function Page({ data }) {
  return <div>{/* Render content */}</div>;
}
```

### Revalidation Strategy

**Time-based (ISR):**
- All pages have `revalidate: 3600` (1 hour)
- After 1 hour, next request triggers background regeneration
- Stale content served while regenerating

**On-demand (Webhook):**
- Sanity webhook hits `/api/revalidate?secret=XXX`
- Endpoint validates secret, then calls `res.revalidate(path)`
- Specific pages regenerated immediately
- See [DEPLOYMENT.md](DEPLOYMENT.md) for webhook setup

## Available Scripts

### `npm run dev`

Starts the development server at [http://localhost:3000](http://localhost:3000).

- Hot module reloading enabled
- Uses `.env.local` for environment variables
- Data fetched from Sanity on every page refresh

### `npm run build`

Builds the application for production:

1. Pre-renders all static pages to HTML
2. Generates optimized JavaScript bundles
3. Creates sitemap.xml and robots.txt (via next-sitemap)
4. Outputs to `.next/` directory

Build output shows:
- `○` (Static) - Pre-rendered as static HTML
- `●` (SSG) - Pre-rendered with `getStaticProps`
- `λ` (Server) - Rendered on-demand (API routes)

### `npm run start`

Runs the production build locally at [http://localhost:3000](http://localhost:3000).

Requires `npm run build` to be run first.

### `npm run postbuild`

Automatically runs after `npm run build`. Generates sitemap using next-sitemap configuration.

## Environment Variables

Create a `.env.local` file in this directory:

```bash
# Sanity Configuration
NEXT_PUBLIC_SANITY_PROJECT_ID=sierqf4e
NEXT_PUBLIC_SANITY_DATASET=production
SANITY_API_VERSION=2023-08-24

# Revalidation Webhook Secret
REVALIDATE_SECRET=your-random-secret-here
```

**Note:** Variables prefixed with `NEXT_PUBLIC_` are exposed to the browser.

## Sanity Integration

### Client Configuration

Sanity client configured in `lib/sanity.js`:

```javascript
import { createClient } from '@sanity/client';

export const sanityClient = createClient({
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET,
  apiVersion: process.env.SANITY_API_VERSION,
  useCdn: true, // CDN for faster reads
});
```

### GROQ Queries

All queries are organized in `lib/queries/`:
- `contentQueries.js` - Article and content queries
- `issueQueries.js` - Issue queries
- `sectionQueries.js` - Section queries
- `authorQueries.js` - Author queries

Example query:
```javascript
export const getContentBySlug = `*[_type == "contentItem" && slug.current == $slug][0]{
  _id,
  title,
  slug,
  publishedAt,
  author->{name, slug},
  section->{name, slug, color},
  content,
  featured,
  "imageUrl": mainImage.asset->url
}`;
```

## SEO Implementation

### Meta Tags (next-seo)

Each page uses the `<NextSeo>` component:

```javascript
import { NextSeo } from 'next-seo';

export default function Page({ data }) {
  return (
    <>
      <NextSeo
        title={data.title}
        description={data.excerpt}
        openGraph={{
          title: data.title,
          description: data.excerpt,
          images: [{ url: data.imageUrl }],
        }}
      />
      {/* Page content */}
    </>
  );
}
```

### Structured Data (JSON-LD)

Structured data schemas in `lib/seo/`:
- Article schema for content pages
- Person schema for author pages
- Organization schema for site-wide
- BreadcrumbList for navigation

### Sitemap Generation

Sitemap automatically generated post-build using `next-sitemap`:

- Homepage priority: 1.0
- Articles priority: 0.9
- Issues priority: 0.8
- Sections priority: 0.7
- Authors priority: 0.6

Configuration in `next-sitemap.config.js`.

## Styling with Theme UI

All components use Theme UI for consistent styling:

```javascript
/** @jsxImportSource theme-ui */

export default function Component() {
  return (
    <div sx={{
      color: 'text',
      bg: 'background',
      fontSize: 3,
      p: 4,
    }}>
      Content
    </div>
  );
}
```

Theme configuration in `lib/theme/theme.js`:
- Colors, typography, spacing scales
- Responsive breakpoints
- Component variants

## Image Optimization

Images served from Sanity CDN with query parameters for optimization:

```javascript
import imageUrlBuilder from '@sanity/image-url';

const builder = imageUrlBuilder(sanityClient);

export function urlFor(source) {
  return builder.image(source);
}

// Usage
<img src={urlFor(image).width(800).url()} alt="..." />
```

Next.js `remotePatterns` configured in `next.config.js` for `cdn.sanity.io`.

## Performance

### Before Migration (Create React App)
- First Contentful Paint: 3-5s
- Time to Interactive: 5-7s
- Lighthouse Score: 40-60
- Client-side rendering (blank page until JS loads)

### After Migration (Next.js SSG)
- First Contentful Paint: 0.5-1s
- Time to Interactive: 1-2s
- Lighthouse Score: 90-100
- Pre-rendered HTML (instant content)

See [DEPLOYMENT.md](DEPLOYMENT.md) for detailed performance metrics.

## Common Development Tasks

### Adding a New Page

1. Create file in `pages/` directory
2. Export a default React component
3. Add `getStaticProps` for data fetching (if needed)
4. Add SEO metadata with `<NextSeo>`

### Adding a New Dynamic Route

1. Create file with bracket syntax (e.g., `[slug].js`)
2. Implement `getStaticPaths` to generate paths
3. Implement `getStaticProps` to fetch data
4. Set `revalidate` for ISR

### Adding a New GROQ Query

1. Create/update query file in `lib/queries/`
2. Export as a string constant
3. Use with `sanityClient.fetch(query, params)`

### Updating Styles

1. Edit theme in `lib/theme/theme.js` for global changes
2. Use `sx` prop for component-specific styles
3. Use `/** @jsxImportSource theme-ui */` pragma at top of file

## Deployment

See [DEPLOYMENT.md](DEPLOYMENT.md) for detailed deployment instructions including:
- Vercel setup (recommended)
- Environment variable configuration
- Webhook configuration for on-demand revalidation
- Performance optimization tips

## Troubleshooting

### Build Errors

**"Cannot find module"** - Run `npm install` to ensure dependencies are installed.

**"Invalid Sanity credentials"** - Check `.env.local` has correct project ID and dataset.

### Development Issues

**"Changes not appearing"** - Hard refresh (Cmd+Shift+R) or clear `.next/` folder.

**"Sanity data not updating"** - Ensure Sanity Studio is publishing changes, not just saving drafts.

### Production Issues

**"Page not found (404)"** - Path might not be in `getStaticPaths`. Check `fallback` setting.

**"Stale content"** - Wait for revalidation period (1 hour) or trigger webhook.

## Learn More

- [Next.js Documentation](https://nextjs.org/docs)
- [Next.js Pages Router](https://nextjs.org/docs/pages)
- [Sanity Documentation](https://www.sanity.io/docs)
- [Theme UI Documentation](https://theme-ui.com/)
- [ISR Documentation](https://nextjs.org/docs/pages/building-your-application/data-fetching/incremental-static-regeneration)

## Contributing

See [CONTRIBUTING.md](../CONTRIBUTING.md) for guidelines on contributing to this project.
